# Dev Doc • 18/09/2025

**Progetto:** Corsi file‑based (Flowpulse / PosturaCorretta)

**Obiettivo:** Struttura corsi/lezioni/schede 100% da YAML (senza DB), URL canonici stabili su `academy.*`, tassonomia auto‑derivata dalle cartelle (per breadcrumb e categorie), SEO pulita, multi‑dominio, e tooling per lint/duplicati slug.

---

## 1) Visione & Scelte chiave

* **File‑based first:** i contenuti vivono in `config/courses/**/**/*.yml`.
* **Slug‑driven:** `course.slug`, `lesson.slug`, `sheet.slug` governano gli URL.
* **URL canonici piatti (SEO):**

  * Corso: `/courses/:course_slug`
  * Lezione: `/courses/:course_slug/lessons/:lesson_slug`
  * Scheda: `/courses/:course_slug/lessons/:lesson_slug/sheets/:sheet_slug`
* **Tassonomia ≠ URL:** la tassonomia arriva dalle **cartelle** (breadcrumb + categorie), NON dal path canonico → spostare file **non rompe** gli URL.
* **Multi‑dominio:** lista di host abilitati nel YAML (`routing.entrypoints.domain`). Se l’host corrente non è abilitato → **301** a quello preferito.
* **Administrate facoltativo:** link custom in sidebar verso una pagina admin\_index (senza tabella).

---

## 2) Struttura cartelle & YAML

**Struttura cartelle (esempio):**

```
config/courses/flowpulse/salute/posturacorretta/postura_e_fisiologia/massaggio_coscienza_corporea/igiene_posturale.yml
```

**Schema YAML (estratto):**

```yaml
spec_version: "1.0"
course:
  slug: igiene_posturale
  titolo: "Igiene Posturale"

  routing:
    entrypoints:
      - domain: academy.flowpulse.net
      - domain: academy.posturacorretta.org
      - domain: academy.igieneposturale.it

  professional_roles: [utente, insegnante, tutor, tirocinante, segnalatore, responsabile_sala, admin_posturacorretta]
  pacchetti:
    - { slug: autonomo_online, canale: online, modalita: autonomia, prezzo_eur: 80, attivo: true, revenue_shares: { insegnante: 60, admin_posturacorretta: 40 } }

  url_pdf: ""
  url_video: ""
  url_content: ""

  moduli_propedeutici:
    - { slug: iscrizione_profilazione, title: "Iscrizione e Profilazione", shared: true }
    - { slug: igiene_posturale_introduzione, title: "Introduzione", shared: true }

  lessons:
    - slug: igiene_posturale_l1
      title: "Lezione 1"
      order: 1
      description: "Mobilizzazione articolare"
      url_pdf: ""
      url_video: ""
      url_content: ""
      sheets:
        - { slug: rigidità, type: teoria_perché, title: "", description: "...", url_pdf: "", url_video: "", url_content: "" }
        - { slug: pratica_mobilizzazioni, type: pratica_cosa, title: "", description: ["Mobilizzazione delle principali articolazioni."], url_pdf: "", url_video: "", url_content: "" }
    - { slug: igiene_posturale_l2, title: "Lezione 2", order: 2, description: "..." }
    - { slug: igiene_posturale_l3, title: "Lezione 3", order: 3, description: "..." }
    - { slug: igiene_posturale_l4, title: "Lezione 4", order: 4, description: "..." }
    - { slug: igiene_posturale_chiusura, title: "Chiusura", order: 5, description: "Feedback e prosecuzione" }
```

**Regole slug:**

* `course.slug` **univoco globale**.
* `lesson.slug` univoco **dentro il corso**.
* `sheet.slug` univoco **dentro la lezione**.

---

## 3) PORO (senza DB)

**`app/models/course.rb`** (responsabilità principali):

* Carica TUTTI i file `*.yml` (con memoization), estrae `taxonomy_path` dalle cartelle.
* Espone `entrypoint_hosts`, `visible_on_host?(host)`, `preferred_host`.
* Trova corso per `slug`, filtra per prefisso di tassonomia, costruisce `lessons`.

**`app/models/lesson.rb`**: incapsula meta della lezione + lista `sheets`.

**`app/models/sheet.rb`**: incapsula meta della scheda.

> Nota: i PORO implementati includono già tutti i campi del YAML (roles, pacchetti, url\_\*) e metodi helper (es. `course.lesson(slug)`, `lesson.sheet(slug)`).

---

## 4) Rotte

```ruby
# config/routes.rb

# Canoniche (SEO) su dominio academy.*
resources :courses, param: :id, only: %i[index show] do
  resources :lessons, param: :id, only: %i[show] do
    resources :sheets, param: :id, only: %i[show]
  end
end

# Categorie (facoltative): /categories/<tax>/...
get "categories/*taxonomy", to: "courses#index", as: :category
```

> In produzione: facoltativo vincolare con constraint `subdomain: /academy/` se servono regole rigide sugli host.

---

## 5) Controller (host redirect + canonical + breadcrumb)

**CoursesController#show:**

* Carica `@course` da `Course.find(params[:id])`.
* Se host **non** abilitato → `301` verso `preferred_host` (entrypoints.first) + path canonico.
* Imposta `@canonical_url` (usato nel layout per `<link rel="canonical" ...>`).
* Breadcrumb costruito da `@course.taxonomy_path` (cartelle → categorie).

**LessonsController#show** e **SheetsController#show:**

* Come sopra, con lookup annidato: corso → lezione → scheda.

---

## 6) Views & UI helper

**Helper (link e badge):**

* `resource_links(url_content:, url_video:, url_pdf:)` → trio di link.
* `type_badge(text)` → pill badge per tipo scheda.

**Partials UI:**

* `_breadcrumb.html.erb` → riceve `crumbs` (hash ordinato: label → path/nil).
* `_card.html.erb` → contenitore con header.
* `_list_row.html.erb` → riga lista cliccabile con badge e azioni.

**Pagine base:**

* `courses#index` → griglia corsi, link alle categorie (se filtrato).
* `courses#show` → dettagli corso + elenco lezioni.
* `lessons#show` → dettagli lezione + indice `sheets`.
* `sheets#show` → contenuti scheda + link risorse.

**Breadcrumb dinamico (esempio in `courses#show`):**

```erb
<% crumbs = { "Corsi" => academy_courses_path } %>
<% path_accum = [] %>
<% @course.taxonomy_path.each do |seg| %>
  <% path_accum << seg %>
  <% crumbs[seg.humanize] = category_path(taxonomy: path_accum.join("/")) %>
<% end %>
<% crumbs[@course.titolo] = nil %>
<%= render "shared/breadcrumb", crumbs: crumbs %>
```

---

## 7) SEO

* **Canonical**: nel layout inserire `<link rel="canonical" href="<%= @canonical_url %>">` se presente.
* **JSON‑LD**:

  * `Course` (pagina corso), con `name`, `description`, `provider`.
  * `ItemList` per l’elenco lezioni.
  * `BreadcrumbList` basato su `taxonomy_path`.
* **Sitemap** per host: elencare tutte le show canoniche (course/lesson/sheet) **visibili su quell’host**.
* **Cache HTTP**: `fresh_when(etag: sha, last_modified: mtime)` dove `sha` e `mtime` derivano dal contenuto YAML (vedi §8).

**Snippet JSON‑LD BreadcrumbList (esempio corso):**

```erb
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    <% list = [] %>
    <% list << { "@type": "ListItem", "position": 1, "name": "Corsi", "item": url_for(courses_path) } %>
    <% @course.taxonomy_path.each_with_index do |seg, i| %>
      <% list << { "@type": "ListItem", "position": i+2, "name": seg.humanize, "item": url_for(category_path(taxonomy: @course.taxonomy_path.first(i+1).join("/"))) } %>
    <% end %>
    <% list << { "@type": "ListItem", "position": list.size+1, "name": @course.titolo, "item": url_for(course_path(@course.slug)) } %>
    <%= raw(list.to_json) %>
  ]
}
</script>
```

---

## 8) Cache & rilevamento cambi

* **Memoize** `Course.all` in processo.
* **Fingerprint**: per ogni file YAML calcola `sha1(File.read)` e `mtime`.
  Combina in un digest di pagina (course/lesson/sheet) e usa:

  ```ruby
  fresh_when etag: digest, last_modified: latest_mtime
  ```
* **Dev reload**: invalida cache quando cambia `mtime`.

---

## 9) Lint slug (duplicati/mancanti)

**Service:** `app/services/course_slug_checker.rb`
**Rake:** `lib/tasks/courses.rake`

Comandi:

```bash
bin/rails courses:check_slugs       # stampa report, exit 1 se problemi
COURSES_LINT_ON_BOOT=1 bin/rails s  # avvisa in dev al boot (initializer opzionale)
```

Controlli effettuati:

* Duplicati per `course.slug` (globale)
* Duplicati per `lesson.slug` (per corso)
* Duplicati per `sheet.slug` (per lezione)
* Slug mancanti (course/lesson/sheet)

Opzionale: modalità strict globale per lesson/sheet con flag ENV.

---

## 10) Integrazione Admin (opzionale)

* Rotta custom: `get :admin_index` in `resources :courses`.
* View `courses/admin_index.html.erb` → elenco corsi YAML.
* Sidebar Administrate: override `_navigation.html.erb` e aggiungi link a `admin_index_courses_path`.

> Administrate resta separato: nessun model AR richiesto.

---

## 11) Deploy & multi‑dominio (Traefik/Kamal)

* **Traefik**: regola `HostRegexp("academy.{domain:.+}")` per far puntare più host allo stesso servizio Rails.
* **TLS**: certificati automatici per i tre entrypoint (flowpulse/posturacorretta/igieneposturale).
* **Rails**:

  * usa `request.host` per verificare `visible_on_host?` e redirigere 301 a `preferred_host`.
  * `default_url_options[:host]` dinamico da request (o middleware) per URL helper corretti.
* **Sitemap/robots per host**: rispondere con risorse visibili su quell’host.

---

## 12) Onboarding sviluppatori (checklist)

1. Clona repo e installa dipendenze.
2. Verifica presenza file YAML in `config/courses/**/**/*.yml`.
3. Avvia server: `bin/dev` o `bin/rails s`.
4. Check slug: `bin/rails courses:check_slugs`.
5. Visita `http://academy.local.test:3000/courses`.
6. Aggiungi un corso copiando un file `.yml` in una nuova cartella tassonomica; aggiorna gli slug; ricarica.
7. (Facoltativo) Aggiungi entrypoint domains nel YAML e simula host con `/etc/hosts`.

---

## 13) Testing

* **Unit**: parsing YAML, uniqueness slugs, `where_taxonomy_prefix`, visibilità host.
* **Controller**: 200 su show validi, 404/redirect su host non abilitati.
* **View**: breadcrumb corretto per diverse tassonomie; JSON‑LD presente.

---

## 14) Migrazione futura a DB (piano)

* Introdurre model AR `Course`, `Lesson`, `Sheet` con `slug` univoci.
* Comando import: YAML → DB (preservando slug/ID logici).
* Continuare a servire URL canonici esistenti; aggiungere caching a livello AR.
* (Optional) Editor in‑app per contenuti (scrittura su DB; YAML come sorgente di verità solo in dev/stage).

---

## 15) Riepilogo file principali creati

* `app/models/course.rb`, `app/models/lesson.rb`, `app/models/sheet.rb`
* `app/controllers/courses_controller.rb`, `lessons_controller.rb`, `sheets_controller.rb`
* `app/helpers/courses_helper.rb`
* `app/views/shared/_breadcrumb.html.erb`, `_card.html.erb`, `_list_row.html.erb`
* `app/views/courses/index.html.erb`, `show.html.erb`
* `app/views/lessons/show.html.erb`
* `app/views/sheets/show.html.erb`
* `app/services/course_slug_checker.rb`
* `lib/tasks/courses.rake`
* (opzionale) `config/initializers/courses_lint.rb`

---

## 16) TODO / Next

* Aggiungere JSON‑LD completo per Course/ItemList/LearningResource.
* Generatore `sitemap.xml` per host (rispettando `visible_on_host?`).
* ETag/Last‑Modified con fingerprint YAML.
* Pulsante "Esporta PDF" della lezione (merge di sheets).
* UI tab nella pagina corso (Lezioni / Pacchetti / Routing / Ruoli).

---

**Autore:** Mark + Copilota • *rev: 18/09/2025*
