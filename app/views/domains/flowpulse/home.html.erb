<%# ---------- setup dati ---------- %>
<% groups = if DomainRegistry.respond_to?(:grouped_domains_for_home)
               DomainRegistry.grouped_domains_for_home
             else
               list = DomainRegistry.domains.values
               grouped = list.group_by { |d| d["category_flowpulse"].to_s.presence || "formazione" }
               { "salute" => grouped["salute"] || [],
                 "lavoro" => grouped["lavoro"] || [],
                 "formazione" => grouped["formazione"] || [] }
             end %>
<% user_subs = (Current.user&.domain_subscriptions&.pluck(:host) || []) rescue [] %>
<% proto = request.protocol %>
<% port  = (request.port && ![80,443].include?(request.port)) ? ":#{request.port}" : "" %>
<div class="max-w-7xl mx-auto px-4 py-10">
  <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
    <div class="min-w-0">
      <h1 class="text-3xl font-bold">Domini Flowpulse</h1>
      <p class="text-sm text-gray-600">
        Attiva i brand (domini) che vuoi vedere nella tua dashboard. I servizi del dominio sono disponibili in base a <code>active_services</code>.
      </p>
    </div>
    <div class="flex items-center gap-2">
      <label class="flex items-center gap-2 text-sm">
        <input id="only-subscribed" type="checkbox" class="h-4 w-4" />
        Mostra solo attivati
      </label>
      <input id="search" type="search" placeholder="Cerca dominio…" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
    </div>
  </header>
  <%# ----- SEZIONI PER CATEGORIA ----- %>
  <% { "salute" => "Salute", "lavoro" => "Lavoro", "formazione" => "Formazione" }.each do |cat_key, cat_label| %>
    <% doms = groups[cat_key] || [] %>
    <% next if doms.empty? %>
    <section class="space-y-4 mb-12">
      <div class="flex items-end justify-between gap-3">
        <h2 class="text-xl font-semibold"><%= cat_label %></h2>
        <span class="text-sm text-gray-500"><%= doms.size %> elementi</span>
      </div>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3" id="domains-grid-<%= cat_key %>">
        <% doms.each do |dom| %>
          <% host = dom["host"] %>
          <% seo   = dom["seo"] || {} %>
          <% title = seo["title"].presence || host %>
          <% desc  = dom["description"].presence || seo["description"] %>
          <% fav   = dom["favicon_url"].presence %>
          <% active = user_subs.include?(host) %>
          <article class="card rounded-xl border border-gray-200 bg-white overflow-hidden transition-all"
                   data-title="<%= title.to_s.downcase %>"
                   data-subscribed="<%= active %>">
            <div class="cover aspect-[16/9] flex items-center justify-between px-4">
              <div class="flex items-center gap-3">
                <% if fav %>
                  <img src="<%= fav %>" alt="" class="w-8 h-8 rounded-md">
                <% else %>
                  <div class="w-8 h-8 rounded-md bg-white/70 flex items-center justify-center font-bold text-gray-700">
                    <%= host.first.upcase %>
                  </div>
                <% end %>
                <div>
                  <div class="text-gray-700 text-sm"><%= host %></div>
                  <div class="text-xs text-gray-500">Servizi: <%= Array(dom["active_services"]).map(&:to_s).join(", ").presence || "—" %></div>
                </div>
              </div>
              <span class="badge <%= active ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-700' %>">
                <%= active ? 'Attivo' : 'Non attivo' %>
              </span>
            </div>
            <div class="p-4 flex flex-col gap-3">
              <h3 class="font-semibold text-gray-900 leading-tight"><%= title %></h3>
              <% if desc.present? %>
                <p class="text-sm text-gray-600"><%= desc %></p>
              <% end %>
              <div class="flex flex-wrap gap-2 mt-1">
                <% if authenticated? %>
                  <% if active %>
                    <%= link_to "Disattiva",
        unsubscribe_domain_path(host: host),
        data: { turbo_method: :delete, turbo_confirm: "Disattivare #{host}?" },
        class: "px-3 py-2 text-sm rounded-lg border border-red-600 text-red-700 hover:bg-red-50" %>
                  <% else %>
                    <%= link_to "Attiva",
        subscribe_domain_path(host: host),
        data: { turbo_method: :post },
        class: "px-3 py-2 text-sm rounded-lg border border-green-600 text-white bg-green-600 hover:bg-green-700" %>
                  <% end %>
                <% else %>
                  <%= link_to "Accedi per attivare",
                      (defined?(new_session_path) ? new_session_path : "/session/new"),
                      class: "px-3 py-2 text-sm rounded-lg border border-blue-600 text-white bg-blue-600 hover:bg-blue-700" %>
                <% end %>
                <%= link_to "Apri dominio",
                    "#{proto}#{host}#{port}/",
                    class: "px-3 py-2 text-sm rounded-lg border border-gray-300 hover:border-gray-400",
                    target: "_blank", rel: "noopener" %>
                <% if (sub = (DomainRegistry.service(:onlinecourses) || DomainRegistry.service("onlinecourses"))&.dig("subdomain")) %>
                  <%= link_to "Hub",
                      "#{proto}#{sub}.#{host}#{port}/",
                      class: "px-3 py-2 text-sm rounded-lg border border-gray-300 hover:border-gray-400",
                      target: "_blank", rel: "noopener" %>
                <% end %>
              </div>
            </div>
          </article>
        <% end %>
      </div>
    </section>
  <% end %>
</div>
<script>
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function applyFilters(){
    const onlySub = $('#only-subscribed')?.checked;
    const q = ($('#search')?.value || '').trim().toLowerCase();

    $$('div[id^="domains-grid-"] article.card').forEach(card => {
      const t = card.dataset.title || '';
      const sub = card.dataset.subscribed === 'true';
      const ok = (!q || t.includes(q)) && (!onlySub || sub);
      card.style.display = ok ? '' : 'none';
    });
  }

  $('#only-subscribed')?.addEventListener('change', applyFilters);
  $('#search')?.addEventListener('input', applyFilters);
  applyFilters();
</script>
