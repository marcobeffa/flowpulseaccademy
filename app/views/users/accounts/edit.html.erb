<!-- app/views/users/accounts/edit.html.erb -->
<div class="max-w-3xl mx-auto">
  <!-- Tabs + Logout -->
  <div class="flex items-center justify-between mb-6">
    <div class="inline-flex rounded-xl bg-slate-100 p-1">
      <%= link_to "Profilo",
          edit_account_path,
          class: "px-4 py-2 text-sm font-medium rounded-lg #{current_page?(edit_account_path) ? 'bg-white shadow text-slate-900' : 'text-slate-600 hover:text-slate-900'}" %>
      <%= link_to "Password",
          edit_change_passwords_path,
          class: "px-4 py-2 text-sm font-medium rounded-lg #{current_page?(edit_change_passwords_path) ? 'bg-white shadow text-slate-900' : 'text-slate-600 hover:text-slate-900'}" %>
    </div>
    <%= button_to "Esci",
        session_path,
        method: :delete,
        form: { data: { turbo_confirm: "Confermi il logout?" } },
        class: "inline-flex items-center rounded-lg bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-red-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-red-600" %>
  </div>
  <div class="rounded-2xl bg-white p-6 shadow">
    <h1 class="text-xl font-semibold text-slate-900 mb-4">Impostazioni Account</h1>
    <%= form_with model: @user, url: account_path, method: :patch, local: true, class: "space-y-8" do |f| %>
      <% if @user.errors.any? || @user.lead&.errors&.any? %>
        <div class="rounded-xl border border-red-200 bg-red-50 p-4">
          <p class="font-semibold text-red-800">Ci sono errori nel form:</p>
          <ul class="mt-2 list-disc pl-5 text-sm text-red-700">
            <% @user.errors.full_messages.each { |m| %>
            <li><%= m %></li>
            <% } %>
            <% @user.lead&.errors&.full_messages&.each { |m| %>
            <li><%= m %></li>
            <% } %>
          </ul>
        </div>
      <% end %>
      <!-- Dati utente (auth) -->
      <div class="grid gap-6 md:grid-cols-2">
        <div>
          <%= f.label :email_address, "Email di accesso", class: "block text-sm font-semibold text-gray-700 mb-2" %>
          <%= f.email_field :email_address, autocomplete: "email",
                class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
        </div>
      </div>
      <hr class="my-2">
      <!-- Dati di contatto (profilo pubblico) -->
      <%= f.fields_for :lead, (@user.lead || @user.build_lead) do |c| %>
        <h2 class="text-lg font-semibold text-slate-900">Dati di contatto</h2>
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <%= c.label :nome, "Nome", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= c.text_field :nome, required: true,
                  class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
          </div>
          <div>
            <%= c.label :cognome, "Cognome", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= c.text_field :cognome, required: true,
                  class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
          </div>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <%= c.label :email, "Email di contatto", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= c.email_field :email, required: true,
                  class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
          </div>
          <div>
            <%= c.label :telefono_facoltativo, "Telefono", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%= c.telephone_field :telefono_facoltativo, autocomplete: "tel",
                  class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
          </div>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          <div>
            <%= c.label :diventa_insegnante, "Vuole diventare insegnante?", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <label class="inline-flex items-center gap-2">
              <%= c.check_box :diventa_insegnante,
                    class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
              <span class="text-sm text-gray-700">Sì</span>
            </label>
          </div>
          <div>
            <%= c.label :tipo_utente, "Tipo utente", class: "block text-sm font-semibold text-gray-700 mb-2" %>
            <%# Se Lead ha enum tipo_utente, usa le chiavi; altrimenti fallback numerico %>
            <% tipo_options =
                (Lead.respond_to?(:tipo_utentes) ? Lead.tipo_utentes.keys.map { |k| [k.humanize, k] } :
                  [["Utente", 0], ["Professionista salute", 1], ["Professionista benessere", 2]]) %>
            <% if Lead.respond_to?(:tipo_utentes) %>
              <%= c.select :tipo_utente, tipo_options, {}, class: "w-full rounded-lg border-2 border-gray-200 bg-white px-4 py-3 focus:border-blue-500 focus:outline-none" %>
            <% else %>
              <%= c.number_field :tipo_utente, min: 0,
                    class: "w-full rounded-lg border-2 border-gray-200 bg-gray-50 px-4 py-3 focus:border-blue-500 focus:bg-white focus:outline-none" %>
            <% end %>
          </div>
        </div>
        <!-- Geolocalizzazione -->
        <div data-controller="geolocate"
     class="rounded-xl border border-slate-200 p-4 bg-slate-50">
          <div class="flex items-center justify-between gap-3">
            <div>
              <h3 class="text-sm font-semibold text-slate-800">
                Residenza di riferimento
                <% if Current.user.lead.address.present? %>
                  <br>
                  <span class="text-lg text-slate-500"><%= Current.user.lead.address %></span>
                <% elsif Current.user.lead.lat && Current.user.lead.lng %>
                  <br>
                  <span class="text-lg text-slate-400">[<%= Current.user.lead.lat %>, <%= Current.user.lead.lng %>]</span>
                <% end %>
              </h3>
              <p data-geolocate-target="status"
         class="text-xs text-slate-600">
                Premi “Aggiorna posizione” per compilare automaticamente lat/lng.
              </p>
            </div>
            <button type="button"
            data-action="geolocate#getPosition"
            data-geolocate-target="button"
            class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700">
              Aggiorna posizione
            </button>
          </div>
          <!-- Campi nascosti che verranno compilati via JS -->
          <%= c.hidden_field :lat,  data: { geolocate_target: "lat" } %>
          <%= c.hidden_field :lng,  data: { geolocate_target: "lng" } %>
        </div>
      <% end %>
      <div class="pt-2">
        <%= f.submit "Aggiorna profilo",
            class: "rounded-full bg-blue-600 px-8 py-3 font-semibold text-white shadow hover:bg-blue-700" %>
      </div>
    <% end %>
  </div>
</div>
